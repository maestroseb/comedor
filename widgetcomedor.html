<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ de Hoy</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-brand {
            font-family: 'Pacifico', cursive;
        }
    </style>
</head>
<body class="bg-transparent">

    <!-- Contenedor del Widget -->
    <div id="menu-widget-container" class="w-full max-w-xs mx-auto bg-white rounded-2xl shadow-lg p-5 border-t-4 border-cyan-500">
        <!-- El contenido se insertar√° aqu√≠ por JavaScript -->
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-pyua5eFZ5z974Y_x0mIY7AvLRBEM4aaa_p69r9G4VXHP7NYilGJG4vfzwoYedMEmT_MLgEIVCCpZ/pub?output=csv";

        // --- L√ìGICA DEL WIDGET ---

        /**
         * Formatea una fecha en el formato DD/MM/YYYY
         * @param {Date} date - El objeto Date a formatear.
         * @returns {string} - La fecha formateada.
         */
        function formatDate(date) {
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }

        /**
         * Formatea una fecha en el formato "D√≠a, DD Mes YYYY" (sin "de")
         * @param {Date} date - El objeto Date a formatear.
         * @returns {string} - La fecha formateada completa.
         */
        function formatFullDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };
            let formattedDate = date.toLocaleDateString('es-ES', options);
            // Reemplazamos " de " con un espacio para un formato m√°s compacto
            formattedDate = formattedDate.replace(/ de /g, ' ');
            return formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);
        }

        /**
         * Renderiza el contenido del widget.
         * @param {object|null} menuData - Los datos del men√∫ de hoy, o null si no hay.
         */
        function renderWidget(menuData) {
            const container = document.getElementById('menu-widget-container');
            let contentHTML = '';

            if (menuData) {
                // Si es un d√≠a especial o festivo
                if (menuData.isSpecial || menuData.isHoliday) {
                    contentHTML = `
                        <div class="flex items-center gap-3 mb-3">
                            <div class="text-4xl">${menuData.icon}</div>
                            <div class="text-left">
                                <h2 class="text-xl font-bold text-gray-800 leading-tight">Men√∫ de Hoy</h2>
                                <p class="text-gray-500 text-sm">${menuData.fullDate}</p>
                            </div>
                        </div>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-r-lg">
                            <p class="font-semibold text-yellow-800 text-sm">${menuData.meals[0]}</p>
                        </div>
                    `;
                } else {
                // Si es un d√≠a normal de men√∫
                    contentHTML = `
                        <div class="flex items-center gap-3 mb-3">
                            <div class="text-4xl">${menuData.icon}</div>
                            <div class="text-left">
                                <h2 class="text-xl font-bold text-gray-800 leading-tight">Hoy Comemos</h2>
                                <p class="text-gray-500 text-sm">${menuData.fullDate}</p>
                            </div>
                        </div>
                        <div class="space-y-3 mt-3">
                            <div>
                                <h3 class="font-semibold text-gray-700 flex items-center text-base"><i class="fas fa-utensils mr-2 text-orange-500"></i>Platos</h3>
                                <ul class="text-sm text-gray-600 space-y-1 mt-1 pl-6">
                                    ${menuData.meals.map(meal => `<li class="list-disc">${meal}</li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 flex items-center text-base"><i class="fas fa-ice-cream mr-2 text-pink-500"></i>Postre</h3>
                                <p class="text-sm text-gray-600 mt-1 pl-6">${menuData.dessert}</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Si no hay men√∫ para hoy
                contentHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-4xl">üè†</div>
                        <div class="text-left">
                            <h2 class="text-xl font-bold text-gray-800 leading-tight">¬°Buen provecho!</h2>
                            <p class="text-gray-500 text-sm">${formatFullDate(new Date())}</p>
                        </div>
                    </div>
                `;
            }
            
            // A√±ade un enlace opcional al men√∫ completo
            contentHTML += `
                <div class="text-center mt-5">
                    <a href="https://maestroseb.github.io/comedor/menu.html" target="_blank" rel="noopener noreferrer" class="text-sm font-semibold text-cyan-600 hover:text-cyan-700 transition-colors">Ver men√∫ completo &rarr;</a>
                </div>
            `;

            container.innerHTML = contentHTML;
        }

        /**
         * Funci√≥n principal que se ejecuta al cargar la p√°gina.
         */
        async function main() {
            const container = document.getElementById('menu-widget-container');
            container.innerHTML = `<p class="text-center text-gray-500 animate-pulse">Cargando men√∫ de hoy...</p>`;

            try {
                const response = await fetch(GOOGLE_SHEET_URL + '&t=' + new Date().getTime());
                if (!response.ok) throw new Error('Network response was not ok');
                
                const csvText = await response.text();
                const rows = csvText.trim().split(/\r?\n/).slice(1);
                
                // Usamos una fecha UTC para "hoy" para que coincida con c√≥mo procesamos las fechas del CSV
                const today = new Date();
                const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
                const todayStr = formatDate(todayUTC);

                let todayMenu = null;
                const dayMap = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];

                for (const row of rows) {
                    if (!row || row.trim() === '') continue;

                    const columns = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    const safeColumns = columns.map(field => (field || "").replace(/^"|"$/g, '').trim());

                    const mondayDateStr = safeColumns[0];
                    const dayName = safeColumns[2];
                    const dayOffset = dayMap.indexOf(dayName);

                    if (dayOffset === -1 || !mondayDateStr) continue;

                    // --- INICIO DE LA CORRECCI√ìN ---
                    // Parsear la fecha del lunes (DD/MM/YYYY) para crear un objeto Date de forma robusta
                    const [day, month, year] = mondayDateStr.split('/').map(Number);
                    if (!day || !month || !year) continue; // Saltar si la fecha no es v√°lida
                    
                    // Usamos Date.UTC para evitar problemas con zonas horarias. El mes es 0-indexed (0=Enero).
                    const mondayDate = new Date(Date.UTC(year, month - 1, day));
                    // --- FIN DE LA CORRECCI√ìN ---

                    // Calcular la fecha real de la fila sumando el offset al lunes
                    const actualDate = new Date(mondayDate);
                    actualDate.setUTCDate(mondayDate.getUTCDate() + dayOffset);
                    const actualDateStr = formatDate(actualDate);
                    
                    if (actualDateStr === todayStr) {
                         const specialNotes = safeColumns[3] || '';
                         const mealsCSV = safeColumns[4] || '';
                         const dessert = safeColumns[5] || '';
                         const icon = safeColumns[7] || 'üçΩÔ∏è';
                         
                         const isHoliday = specialNotes.toLowerCase().includes('no lectivo');
                         const isSpecialEvent = specialNotes && !isHoliday;
                         
                         todayMenu = {
                            dayName: dayName,
                            fullDate: formatFullDate(actualDate),
                            meals: isSpecialEvent || isHoliday ? [specialNotes] : mealsCSV.split(';').map(m => m.trim()),
                            dessert: dessert,
                            icon: icon,
                            isSpecial: isSpecialEvent,
                            isHoliday: isHoliday
                         };
                         break; 
                    }
                }
                
                renderWidget(todayMenu);

            } catch (error) {
                console.error("Error al obtener o procesar los datos del men√∫:", error);
                container.innerHTML = `<p class="text-center text-red-500">No se pudo cargar el men√∫.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>

</body>
</html>

